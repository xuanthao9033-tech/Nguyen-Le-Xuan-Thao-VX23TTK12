@using IphoneStoreBE.VModels
@model IphoneStoreFE.Models.PagedEntity<ProductGetVModel>

@{
    Layout = "_Layout";
    ViewData["Title"] = "Trang chủ";
    var userId = ViewBag.UserId ?? 0;
}

<div class="container mt-5">
    <h3 class="text-center">✨ Danh sách sản phẩm nổi bật ✨</h3>

    <div class="row row-cols-1 row-cols-md-4 g-4">
        @foreach (var product in Model?.Items ?? new List<ProductGetVModel>())
        {
            <div class="col">
                <div class="card h-100 shadow-sm border-0 rounded-3">
                    <div class="ratio ratio-4x3 overflow-hidden rounded-top"
                         ondblclick="location.href='@Url.Action("Details", "Product", new { id = product.Id })'">
                        <img src="@Url.Content(string.IsNullOrEmpty(product.ImageUrl) ? "~/images/default-product.jpg" : product.ImageUrl)"
                             alt="@product.ProductName"
                             class="w-100 h-100"
                             style="object-fit: cover; transition: 0.3s;" />
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h6 class="fw-bold mt-2">@product.ProductName</h6>
                        <p class="text-muted mb-2">@string.Format("{0:n0}", product.Price) ₫</p>
                        <div class="mt-auto d-grid gap-2">
                            @if (userId == 0)
                            {
                                <a href="/Account/Login" class="btn btn-outline-primary">
                                    <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                                </a>
                                <a href="/Account/Login" class="btn btn-primary">
                                    <i class="bi bi-bag"></i> Mua ngay
                                </a>
                            }
                            else
                            {
                                <button class="btn btn-outline-primary" onclick="addToCart(@product.Id, 1)">
                                    <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                                </button>
                                <button class="btn btn-primary" onclick="buyNow(@product.Id)">
                                    <i class="bi bi-bag"></i> Mua ngay
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (Model?.TotalPages > 1)
    {
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.PageIndex == 1 ? "disabled" : "")">
                    <a class="page-link" href="?page=@(Model.PageIndex - 1)" aria-label="Trang trước">
                        <span aria-hidden="true">«</span>
                    </a>
                </li>

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                        <a class="page-link" href="?page=@i">@i</a>
                    </li>
                }

                <li class="page-item @(Model.PageIndex == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" href="?page=@(Model.PageIndex + 1)" aria-label="Trang sau">
                        <span aria-hidden="true">»</span>
                    </a>
                </li>
            </ul>
        </nav>
    }
</div>

@section Scripts {
    <script>
        const userId = @Json.Serialize(userId);
        console.log("🟢 userId từ ViewBag: ", userId);

        async function addToCart(productId, quantity) {
            console.log("🟢 [Thêm vào giỏ] BẮT ĐẦU");
            console.log("➡️ Dữ liệu đầu vào:", {
                userId: userId,
                productId: productId,
                quantity: quantity
            });

            try {
                if (!userId || userId === 0) {
                    alert("⚠️ Vui lòng đăng nhập trước khi thêm sản phẩm.");
                    window.location.href = "/Account/Login";
                    return;
                }

                const res = await fetch("/Cart/AddToCart", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: JSON.stringify({ 
                        userId: userId,
                        productId: productId,
                        quantity: quantity
                    })
                });

                console.log("✅ [Trạng thái phản hồi]:", res.status);

                let result;
                try {
                    result = await res.json();
                    console.log("📦 [Dữ liệu phản hồi]:", result);
                } catch (jsonErr) {
                    console.error("❌ [Lỗi phân tích JSON]:", jsonErr);
                    alert("⚠️ Phản hồi máy chủ không hợp lệ.");
                    return;
                }

                if (res.ok && result && result.success) {
                    console.log("🎉 [THÀNH CÔNG] Thông báo:", result.message);
                    alert("✅ " + result.message);
                } else {
                    console.warn("⚠️ [THẤT BẠI] Thông báo:", result.message);
                    alert("❌ " + (result.message || "Không thể thêm vào giỏ hàng."));
                }
            } catch (err) {
                console.error("🚨 [Lỗi kết nối]:", err);
                alert("⚠️ Lỗi kết nối máy chủ.");
            }

            console.log("🔚 [Thêm vào giỏ] KẾT THÚC\n");
        }

        async function buyNow(productId) {
            try {
                const result = await addToCart(productId, 1);
                // Chờ một chút để đảm bảo giỏ hàng đã được cập nhật
                await new Promise(resolve => setTimeout(resolve, 500));
                window.location.href = "/Cart";
            } catch (err) {
                console.error("🚨 [Lỗi mua ngay]:", err);
                alert("⚠️ Có lỗi xảy ra khi thêm vào giỏ hàng.");
            }
        }
    </script>

    <style>
        .card:hover img {
            transform: scale(1.05);
            transition: 0.3s;
        }

        .ratio-4x3 {
            aspect-ratio: 4 / 3;
        }
    </style>
}

